TODO : have zip files or link to bigRNAstorage(near) datas.
TODO : add somewhere Vladimir's script to create the pdb files from connex list.
TODO : how should we handle Varna and RNAalign shold the executable be present or not and how to credit them ? a citer dans le readme et le papier trouver un endroit où placer varna
TODO : update README , introduce a limitation on the set target quickly and explain that it neededs a filter (already done the filter), put a warning about loading on some results if the RAM is not suffisant python ca refuse to load it and "stop the process"
TODO: test the code in a new folder with none of the pattern/target folder built
TODO : separer en 2 folders un avec le tool général et un WABI 2023 avec nos benchs qui ressemblent au dossier dans l'état actuel. 
TODO : nagagamissis mettre les zips bigRNAstorage(near)
TODO : all task with example in the name have goal to make reproducible our test but can required some adaptations to use it directly ith new family of motifs
TODO : ass perhaps specific paragraph in README FOR WABI bench in order to be able 
TODO : should add possibility to launch the tool on only a pattern vs a target
# FuzzTree
# Copyright (C) 2023 THEO BOURY 

# FuzzTree Project

This project present FuzzTree, a new tool to solve the Subgraph Isomorphism Problem in its "Fuzzy" version, that allowed to take into account and search for neighborhoods of the requested pattern.

## Prerequisite and launch

### Dependencies 
The project uses the following non-standard libraries:

* infrared (see https://hal.archives-ouvertes.fr/hal-03711828/document by Hua-Ting Yao, 2022 for more details.
* matplotlib (for vizualizations).
* pickle (for graph imports). (natively installed for python above 3.7 ?)
* seaborn (for visualisation of the cartography and of RMSDs computations)
* networkx (for graph vizualizations).
* varnaapi (for graph vizualizations). 
* random (for some drawings)
* pandas (for some dataframes for drawings)

### Files and repositories
The project is entirely available on the current archive. 

For Target RNA graphs, the used graphs were downloaded at https://uqam-my.sharepoint.com/:u:/g/personal/reinharz_vladimir_uqam_ca/Eb9rc26hI-FPgBuRH8EHR3gByiQmcgCgMu6hAdlK0-EVyA?e=R9FocY (1.5 GB) for graph without near edges and at TODO (size GB) for graphs with near edges. Our recommandation is to extract them respectively into the folders bigRNAstorage and bigRNAstoragenear

The different files are:
* FuzzTree.py: core of the tool, search for Subgraph Isomorphism with neighborhoods.
* Extractor.py and RIN.py to extract the RNA pattern from csv to put them in pickle format files.
* VarnaDrawing.py: contains necessary wrappers to launch Varna on graphs and their mapping.
* TestFuzzTree.py: contains the test framework over the method.
* SliceInCubes.py, to allow big RNA target graphs to be sliced in subgraphs on which apply the methods.
* Cartography.py: method to launch the cartography of the Kink-Turns from an origin graph.
* ExtractAndSearchGeometry.py a postprocessing file, to extract the convex components of the motifs retrieved with FuzzTree method.
* RNAalignusage.py: a postprocessing file, compute RMSDs between Kink-Turns and new found motifs.
* results_storage.py, contain some results that were stored in this file for usage in postprocessing tasks.
* Launcher.py, a file that allow to launch the different tests from command lines.


The different folders are:
* bigRNAstorage (mandatory to build it): To store the Target RNA graphs without near edges
* bigRNAstoragenear (mandatory to build it): To store the Target RNA graphs with near edges
* RNAcsv: The csv files that contains the data on the Kink-Turn retrieved from Rna3DAtlas http://rna.bgsu.edu/rna3dhub/motifs/release/il/3.63
* Allkinkturnpattern and Allkinkturnpatternwithgaps are folder of pattern graphs generated by parsing of RNAcsv files through the method.
* Allkinkturntarget and Allkinkturntargetwithgaps are folder of extracted target graphs generated by parsing of RNAcsv files through the method and serve through the cartography process.
* pdb_kink_files and pdb_files are respectively versions in pdb format of the Kink-Turns motifs and of the motifs that we found with our FuzzTree method. 
* TimeGraphBrut.py contain some results on time that were stored for usage in postprocessing tasks.

### Get started

First, this project will require Anaconda (or at least Miniconda), make sure that conda is installed or you can have a look at https://conda.io/en/latest/miniconda.html for the installation

Make sure next that conda path is known with environement variable:
```bash
export PATHTOCONDA=Your_path_to_conda/conda
```

First init conda :

```bash
conda activate fish
conda config --set auto_activate_base False
ln -s your/path/to/conda/conda conda
```

It is not a mandatory for our method, but in order to obtain some mapping visualisations, we used Varna that can be installed at https://varna.lri.fr/index.php?lang=en&page=downloads&css=varna
Similarly, to reproduce our postprocessing RMSD computation, we used RNAalign http://www.rnabinding.com/RMalign/RMalign.html. Executable should be placed in the current folder. For RNalign, the executable to retrive is RNAalign that should be placed under this name in current folder. 

When conda setup is done, to install the dependencies package you can next type :

```bash
make dependencies
```


You can now launch the test by using: 

```bash
make tests
```
or 
```bash
make tests_no_varna
```
Depending if Varna was installed or not.

If no mistake appears here, you are good to go.

#### Execution script

To launch the FuzzTree method on, you just have to launch:

```
python3 Launcher.py --task launch_fuzztree OPTIONS
```

If you want to launch a benchmark, you can instead launch:

```
python3 Launcher.py --task launch_custom_test OPTIONS
```

If no options are specified default parameters are used
## Option for Fuzziness and parameters

Parameters in OPTIONS can be modified to customize the searched neighborhoods, use multiprocessingn, indicate the pattern or others they are taken as arguments in above command line.
Here are the different options that can be added, none of them is necessary and default parameters is used when not specified:

--L, default 20, specifies the threshold on the sum of distances in isostericity between labels in the searched pattern and corresponding labels in the found pattern. 
--E, default 4, specifies the threshold on the number of interactions that we allow to be missing (number of edges missing).
--G, default 20, specifies the threshold on the sum of geometrical distances covered by gaps.
--Dgap, default 10, specifies the geometric distance at which we allow to look for potential gap.
--Dedge, default 5, specifies the geometric distance at which we allow to look for potential missing edges. 
--number, default 0, the pid of current task, useful to launch Fuzztree on distributed system. The pid also choose the target graphs on which to work on, by default, we work only with the RNAs of small size, changing the pid allows to work on different larger graphs.
--procs, default 1, the number of processors on which we want to work
--timeout, default 108000 for each small graphs and 2000 for subparts of big graphs, the maximum time in seconds that we allow for the computation on each instance. (subgraphs of big graphs count as 1 instance)
--pattern, default 20kink_turninto5TBW, the pattern from which launch computation that serves in FuzzTree or as origin of the cartography.
--target, default 3NVI, the target graph on which to search for the pattern.
--near, default True, if we consider the near edges or not.
--thresholdbigGT, default 500, the number of nucleotides above which we consider the graph as big and have to cut it in slices.
--samples, default 1000, the number of samples that are drawn during FuzzTree method.
--patterncut, default 5, the place where the backbone of pattern graph is cut.

## Different examples of codes

Here is the list of the different tasks that can be launched using the Launcher.py to reproduce our tests and computations:

--task launch_fuzztree, to laucn FuzzTree to search for a pattern into a target graph.
Used parameters: L, E, G, Dgap, Dedge, procs, timeout, pattern, target, samples, near.

--task launch_custom_test, to launch FuzzTree on a benchmark of multiple targets.
Used parameters: L, E, G, Dgap, Dedge, number, procs, timeout, pattern, thresholdbigGT, samples, near.

--task create_patterns_and_targets, to create the folders Allkinkturnpattern(withgaps) and Allkinkturntarget(withgaps)
Used parameters: None.

--task launch_sanity_test, test to check if FuzzTree is well setted.
Used parameters: None.

--task launch_sanity_test_novarna, test to check if FuzzTree and Varna are well setted.
Used parameters: None.

--task launch_varna_mapping, same than launch_fuzztree but with drawing of the mapping with Varna at the end.
Used parameters: L, E, G, Dgap, Dedge, procs, timeout, pattern, target, samples, near.

--task compute_metrics_example, to compute the metrics of evaluations on the Kink-Turns benchmarks after having retrieved the mappings with launch_custom_test task.
Used parameters: procs, near, patterncut.

--task compute_cartography_kink_turns, compute the Kink-Turn cartography from an origin identified as the pattern graph.
Used parameters: pattern, procs.

--task draw_cartography_example, draw the Kink-Turn cartography using the results obtained from compute_cartography_kink_turns task.
Used parameters: None.

--task connexity_graphs_creation_example, create the connex exhaustive graphs to study from the mappings obtain and stored after launch_custom_test task.
Used parameters: None.

--task connexity_graphs_creation_with_pdb_example, same task but with pdb numbers in the results instaed of local numerotations.
Used parameters: None.

--task compute_new_motifs_RMSD_example, compute the RMSDs between Kink-Turns and the new found motifs as connex graphs, as obtained after connexity_graphs_creation_example/connexity_graphs_creation_with_pdb_example tasks.
Used parameters: None.

--task compute_new_motifs_mean_RMSD_example, same task as above but RMSD computation is a mean of RMSDs values.
Used parameters: None.

--task plot_metrics_example, plot the metrics for Kink-Turns instances that were computed and stored after compute_metrics_example.
Used parameters: near.

--task time_graphs_example, from the time data present in the results of FuzzTree method stored using the debug_output from TestFuzzTree file obtain after launch_custom_test task.
Used parameters: near.

## Knowing bugs and limitations

* All task that contains example are mostly suited to our Kink-Turn benchmark and will need additional adaptations to work with others families of RNAs.
* Some tasks sometimes load some results that can be heavy in term of space. In current release, nothing is done to prevent computers with a too small RAM to fail on these postprocessing tasks.

## Contributors

* Théo Boury
* Vladimir Reinharz






